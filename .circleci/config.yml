# Compile Code, Unit Test, Dependency Scan, Static Analysis Scan, Build Image, Vulnerability Scan, Deploy Image to DockerHub

#version: 2.1
#
#orbs:
#  gradle: circleci/gradle@1.0.0
#  anchore: anchore/anchore-engine@1.4.0
#jobs:
#  build:
#    docker:
#      - image: circleci/openjdk:11-jdk
#    steps:
#      - checkout
#      - run: ./gradlew clean build -x test
#  test:
#    docker:
#      - image: circleci/openjdk:11-jdk
#    steps:
#      - checkout
#      - run: ./gradlew clean build
#  dependency-scan:
#    docker:
#      - image: circleci/openjdk:11-jdk
#    steps:
#      - checkout
#      - run: ./gradlew dependencyCheckAnalyze
#  quality-scan:
#    docker:
#      - image: circleci/openjdk:11-jdk
#    steps:
#      - checkout
#      - run: ./gradlew sonarqube -Dsonar.projectKey=aaronilovici_circle-test -Dsonar.organization=aaronilovici -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=${SONAR_TOKEN} --info
#  create-image:
#    docker:
#      - image: circleci/openjdk:11-jdk
#    steps:
#      - setup_remote_docker:
#          docker_layer_caching: true
#      - checkout
#      - run:
#          command: 'docker build -t "aaronilovici/circletestrepo:1.0.test" .'
#      - run: mkdir -p workspace
#      - run:
#          command: 'docker save aaronilovici/circletestrepo:1.0.test > workspace/circle-test_latest.tar'
#      - persist_to_workspace:
#          root: workspace
#          paths:
#            - circle-test_latest.tar
#  image-scan:
#    executor: anchore/anchore_engine
#    steps:
#      - setup_remote_docker:
#          docker_layer_caching: true
#      - checkout
#      - attach_workspace:
#          at: /tmp/workspace
#      - run:
#          command: 'ls -al /tmp/workspace'
#      - run:
#          command: 'docker load -i /tmp/workspace/circle-test_latest.tar'
#      - anchore/analyze_local_image:
#          dockerfile_path: ./Dockerfile
#          image_name: 'aaronilovici/circletestrepo:1.0.test'
#          policy_bundle_file_path: .circleci/.anchore/policy_bundle.json
#          policy_failure: true
#          timeout: '500'
#      - anchore/parse_reports
#      - store_artifacts:
#          path: anchore-reports
#  deploy:
#    docker:
#        - image: circleci/openjdk:11-jdk
#    steps:
#      - setup_remote_docker:
#          docker_layer_caching: true
#      - checkout
#      - attach_workspace:
#          at: /tmp/workspace
#      - run:
#          command: 'ls -al /tmp/workspace'
#      - run:
#          command: 'docker load -i /tmp/workspace/circle-test_latest.tar'
#      - run:
#          command: 'docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}'
#      - run:
#          command: 'docker push docker.io/aaronilovici/circletestrepo:1.0.test'

version: 2.1
orbs:
  gradle: circleci/gradle@1.0.11
workflows:
  checkout-build-test:
    jobs:
      - gradle/test
  checkout-run_task:
    jobs:
      - gradle/run:
          command: build -x test

#  fullrun:
#    jobs:
#      - build
#      - test:
#          requires:
#            - build
#      - dependency-scan:
#          requires:
#            - test
#      - quality-scan:
#          requires:
#            - test
#      - create-image:
#          requires:
#            - test
#      - image-scan:
#          requires:
#            - create-image
#      - hold:
#          type: approval
#          requires:
#            - image-scan
#      - deploy:
#          requires:
#            - hold
#  tests_only:
#    jobs:
#      - build:
#          filters:
#            branches:
#              only:
#                - dev
#      - test:
#          requires:
#            - build
#          filters:
#            branches:
#              only:
#                - dev